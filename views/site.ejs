<!-- views/site.ejs -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Site List</title>
    <% include partials/headerimports %>
</head>
<body>
    <% include partials/nav.ejs %>
    <div class="container">
          <h2 align="center">Site Details</h2>
          <% include partials/flashMessages.ejs %>
          <form name="siteexports" action="/sites" method="post" class="form-horizontal">
         <fieldset>
        <div class="row col-sm-12">
            <h4 align="center" style="margin-left: 40px">Select your table/export filters</h4>
            <div class="col-sm-5">
                    <div class="form-group">
                        <div class="form-inline">
                            <label for="select" class="control-label">Select your program for export to csv:</label>
                            <div class="">
                                <select class="form-control adminProgram" id="programSelect" name="program">
                                    <option value="Biology Internship (BIOL 4800)">Biology Internship (BIOL 4800)</option>
                                    <option value="Information Technology Internship (ITEC 4900)">Information Technology Internship (ITEC 4900)</option>
                                </select>
                                <button type="submit" class="btn btn-success btn-sm" style="margin-left: 20px">Export</button>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
         </fieldset>
          <fieldset>
              <div class="col-sm-5">
                <div class="form-group">
                    <div class="form-inline">
                        <label for="select" class="control-label">Filter by Company Status:</label>
                        <div class="">
                            <select class="form-control siteStatus" id="sitestatusdd" name="sitestatusdd">
                                    <option selected>Filter by Status</option>
                                <option value="active" >Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
              </div>
          </fieldset>
          </form>
          <br>

        <a id="btn" href="mailto:" onclick="sendAll()"><button >Email All</button></a>  
        <div class="table-responsive">
            <table class="table table-striped table-bordered" id="sites">
                <thead>
                <tr>
                    <th><center>Select</center></th>
                    <th>Name</th>
                    <th>Email Address</th>
                    <th>Address</th>
                    <th>City</th>
                    <th>Program</th>
                    <th>Valid MOU</th>
                    <th>MOU Expiration</th>
                    <th>Edit</th>
                    <th>View Details</th>
                    <th>Site Status</th>
                </tr>
                </thead>
                <tbody>
                <%siteList.forEach(function(site) { %>
                    <tr>
                        <td id="mySelect1">
                            <center>
                                <input id="emailCheckbox" type="checkbox"  value ='<% site.contacts.forEach(function(contact) { %>
                    <%= contact.email %>
                    <% });  %>' />

                            </center>
                        </td>
                        <td><%= site.name %></td>
                        <td>
                        <% site.contacts.forEach(function(contact) { %>
                        <%= contact.email %> 
                        <% }); %> </td>
                        <td><%= site.address %></td>
                        <td><%= site.city %></td>
                        <td><%= site.section %></td>
                        <% if (site.mou==='Yes') { %>
                            <td><%= site.mou %></td>
                        <% } else { %>
                            <td>No</td>
                        <% } %>
                        <td><%= site.mouexpiration %></td>
                        <td><a href="/site/edit/<%= site._id %>"><span class='glyphicon glyphicon-pencil'></span></a></td>
                        <td><a href="/site/<%= site._id %>"><span class='glyphicon glyphicon-search'></span></a></td>
                        <td><%= site.sitestatus %></td>
                    </tr>
                <% }); %>
                </tbody>
            </table>
        </div>
    <form onClick ="displayResult()">
        <i> <b><a  class="three" id="send1" onclick="displayResult()" href="mailto:" >Send email <br><br><br></a></b></i>
    </form>


    <% include partials/footerimports %>
    <script>
        function displayResult() {
            var send = document.getElementById("send1"),
                l = [];


            $("input#emailCheckbox:checked").each(function (index) {

                l.push( this.value.replace(/\s/g, ";"));

                // l.push(this.value.trim());
                send.href = "mailto:" + l.join("");
                console.log(this.value);
                console.log(l);
            } );
            return;

        }

    </script>

    <!-- Email All -->
    <script>var emailList = [];</script>
        <%siteList.forEach(function(site) { %>
            <!-- Concatenate all emails -->
            <% site.contacts.forEach(function(contact) { %>
                <script>
                    emailList.push('<%= contact.email %>');
                </script>
            <% }); %>
        <% }); %>
        <script>  
          function sendAll() {
            var emailbtn = document.getElementById('btn');
            emailbtn.href = "mailto: "+ emailList.join(";");
            return;
          }
    </script>

      <script type="text/javascript">
          $(document).ready(function () {


              makeOptionSelected('programSelect', '<%= admin.adminprogram %>');
              var program = prettySection('<%= admin.adminprogram %>');

              var table = $('#sites').DataTable({
                  "bFilter": true,
                  "pageLength": 50,
                  "columnDefs": [
                      { "orderable": false, "targets": 0 }
                  ]
              });

              table.search().draw();

          });
      </script>
        <script>
            function checkAll()
            {
                let checkboxes = document.getElementsByTagName('input'), val = null;
                for (let i = 0; i < checkboxes.length; i++)
                {
                    if (checkboxes[i].type == 'checkbox')
                    {
                        if (val === null) val = checkboxes[i].checked;
                        checkboxes[i].checked = val;
                    }
                }
            }
        </script>
      </div>
</body>
</html>
